# decentralized-gnn
A package for implementing and simulating decentralized Graph Neural Network algorithms
for classification of peer-to-peer nodes. Developed code supports the publication
*p2pGNN: A Decentralized Graph Neural Network for Node Classification in Peer-to-Peer Networks*.

## :zap: Quick Start

To generate a local instance of a decentralized learning device:
```python
from decentralized.devices import GossipDevice
from decentralized.mergers import SlowMerge
from learning.nn import MLP
node = ... # a node identifier object (can be any object)
features = ... # feature vector, should have the same length for each device
labels = ... # one hot encoding of class labels, zeroes if no label is known
predictor = MLP(features.shape[0], labels.shape[0])  # or load a pretrained model with
device = GossipDevice(node, predictor, features, labels, gossip_merge=SlowMerge)
```

In this code, the type of the device (`GossipDevice`) and the variable merge protocol 
(`SlowMerge`) work together to define a decentralized learning seting for 
a Graph Neural Network that runs on and takes account of unstructured peer-to-peer links
of uncertain availability.

Then, whenever possible (e.g. at worst, whenever devices send messages to the others for
other reasons) perform the following information exchange between linked devices 
`u` and `v`:

```python
send = u.send()
receive = v.receive(u.name, send)
u.ack(v.name, receive)
```


## :hammer_and_wrench: Simulations


Clone the repository and install all dependencies with:

```bash
pip install -r requirements.txt
```

This will also install the infrastructure needed by torch geometric 
to automatically download data. Set up and run simulations on many 
devices automatically generated by existing datasets with the following code:

```python
from decentralized.devices import GossipDevice
from decentralized.mergers import AvgMerge
from decentralized.simulation import create_network

dataset_name = ... # "cora", "citeseer" or "pubmed"
network, test_labels = create_network(dataset_name, 
                                      GossipDevice,
                                      pretrained=False,
                                      gossip_merge=AvgMerge,
                                      gossip_pull=False,
                                      seed=0,
                                      min_communication_rate=0,
                                      max_communication_rate=0.1)
for epoch in range(800):
    network.round()
    accuracy_base = sum(1. if network.devices[u].predict(False) == label else 0 for u, label in test_labels.items()) / len(test_labels)
    accuracy = sum(1. if network.devices[u].predict() == label else 0 for u, label in test_labels.items()) / len(test_labels)
    print(f"Epoch {epoch} \t Acc {accuracy:.3f} \t Base acc {accuracy_base:.3f}")
```

In the above snippet, datasets are automatically downloaded.
Then, devices are instantiated from desired settings.
Communication between pairs of linked devices occurs with probability
*[min_communication_rate, max_communication_rate]* in each round; the probability
is different between each pair of devices but does not change over time.

Everything runs on numpy because, at the time of the first implementation, 
adequate GPU memory was hard to find.


### Reproducibility

Find running implementations in the files *experiments.py*, with centralized
equivalents in *centralized_experiments.py*.
Publication experiments used the downloader of dgl. However, this is not 
working properly anymore and we have switched to torch geometric.
Other than this, default settings match the publication.

### Reducing resources

Some merge schemes need a lot of memory to simulate. Reduce consumption
to a fraction of the original by moving from the default `np.float64` numeric format to less
precise ones. Do so with the pattern demonstrated bellow, where the datatype is passed to the
`dtype` argument of numpy array creation:

```python
learning.optimizers.Variable.datatype = np.float16 # do this before calling `create_network`
```

## :notebook: Citation
```
@article{krasanakis2022p2pgnn,
  title={p2pgnn: A decentralized graph neural network for node classification in peer-to-peer networks},
  author={Krasanakis, Emmanouil and Papadopoulos, Symeon and Kompatsiaris, Ioannis},
  journal={IEEE Access},
  volume={10},
  pages={34755--34765},
  year={2022},
  publisher={IEEE}
}
```
